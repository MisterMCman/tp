generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Country {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  code        String   @unique // ISO 3166-1 alpha-2
  phoneCode   String?  // International phone code
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  trainers    Trainer[]
}

model Trainer {
  id           Int           @id @default(autoincrement())
  firstName    String
  lastName     String
  email        String        @unique
  phone        String
  address      String?       @db.Text
  bio          String?       @db.Text
  profilePicture String?
  bankDetails  String?       @db.Text  // JSON string with bank info: IBAN, BIC, Bank Name, Account Holder
  taxId        String?
  companyName  String?       // Firmenname falls es eine GmbH ist
  isCompany    Boolean       @default(false) // Gibt an ob es sich um eine Firma handelt
  dailyRate    Float?        // Regul채rer Netto-Tagessatz f체r Schulungen 9-16 Uhr
  status       TrainerStatus @default(ACTIVE)
  countryId    Int?          // Reference to Country
  country      Country?      @relation(fields: [countryId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  inquiries    Inquiry[]
  invoices     Invoice[]
  topics       TrainerTopic[]
  loginTokens  LoginToken[]
  topicSuggestions TopicSuggestion[]
  profileVersions TrainerProfileVersion[]
  availabilities Availability[]

  @@index([countryId], map: "Trainer_countryId_fkey")
}

model LoginToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  trainerId Int
  trainer   Trainer  @relation(fields: [trainerId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?

  @@index([trainerId], map: "LoginToken_trainerId_fkey")
}

model Topic {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  trainers TrainerTopic[]
  courses  Course[]
}

model TrainerTopic {
  id        Int      @id @default(autoincrement())
  trainer   Trainer  @relation(fields: [trainerId], references: [id])
  trainerId Int
  topic     Topic    @relation(fields: [topicId], references: [id])
  topicId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([trainerId, topicId]) // Eindeutiger Index statt Prim채rschl체ssel
}

model TopicSuggestion {
  id        Int                 @id @default(autoincrement())
  name      String
  trainer   Trainer             @relation(fields: [trainerId], references: [id])
  trainerId Int
  status    TopicSuggestionStatus @default(PENDING)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@index([trainerId], map: "TopicSuggestion_trainerId_fkey")
  @@index([name], map: "TopicSuggestion_name_idx")
}

model TrainerProfileVersion {
  id            Int      @id @default(autoincrement())
  trainerId     Int
  trainer       Trainer  @relation(fields: [trainerId], references: [id])
  version       Int      // Version number for this trainer
  firstName     String?
  lastName      String?
  email         String?
  phone         String?
  address       String?
  countryId     Int?
  bio           String?
  profilePicture String?
  bankDetails   String?
  taxId         String?
  companyName   String?
  isCompany     Boolean?
  dailyRate     Float?
  changedFields String   // JSON string of changed field names
  changedBy     String   // 'trainer' or 'admin'
  createdAt     DateTime @default(now())

  @@index([trainerId], map: "TrainerProfileVersion_trainerId_fkey")
  @@index([trainerId, version], map: "TrainerProfileVersion_trainerId_version_key")
}

model Inquiry {
  id            Int           @id @default(autoincrement())
  trainerId     Int
  eventId       Int
  status        InquiryStatus @default(PENDING)
  originalPrice Float
  proposedPrice Float
  counterPrice  Float?
  message       String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  event         Event         @relation(fields: [eventId], references: [id])
  trainer       Trainer       @relation(fields: [trainerId], references: [id])

  @@index([eventId], map: "Inquiry_eventId_fkey")
  @@index([trainerId], map: "Inquiry_trainerId_fkey")
}

model Event {
  id           Int           @id @default(autoincrement())
  courseId     Int
  title        String
  date         DateTime
  endTime      DateTime
  location     String
  participants Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  course       Course        @relation(fields: [courseId], references: [id])
  inquiries    Inquiry[]
  eventParticipants Participant[]

  @@index([courseId], map: "Event_courseId_fkey")
}

model Course {
  id          Int         @id @default(autoincrement())
  description String?     @db.Text
  createdAt   DateTime    @default(now())
  state       CourseState @default(ONLINE)
  title       String
  topicId     Int?
  topic       Topic?      @relation(fields: [topicId], references: [id])
  updatedAt   DateTime    @updatedAt
  events      Event[]

  @@index([topicId], map: "Course_topicId_fkey")
}

model Participant {
  id      Int    @id @default(autoincrement())
  name    String
  email   String
  eventId Int
  event   Event  @relation(fields: [eventId], references: [id])

  @@index([eventId], map: "Participant_eventId_fkey")
}

model Invoice {
  id        Int           @id @default(autoincrement())
  trainerId Int
  courseId  Int?
  amount    Float
  status    InvoiceStatus @default(SUBMITTED)
  createdAt DateTime      @default(now())
  trainer   Trainer       @relation(fields: [trainerId], references: [id])

  @@index([trainerId], map: "Invoice_trainerId_fkey")
}

enum TrainerStatus {
  ACTIVE
  INACTIVE
}

enum InquiryStatus {
  PENDING
  ACCEPTED
  REJECTED
  ABGESAGT
  COMPLETED
}

enum CourseState {
  ONLINE
  INACTIVE
}

enum InvoiceStatus {
  SUBMITTED
  PAID
}

model Availability {
  id        Int      @id @default(autoincrement())
  trainerId Int
  trainer   Trainer  @relation(fields: [trainerId], references: [id])
  dayOfWeek Int      // 0 = Sunday, 1 = Monday, etc.
  startTime String   // Format: "HH:mm"
  endTime   String   // Format: "HH:mm"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trainerId], map: "Availability_trainerId_fkey")
}

enum TopicSuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}
